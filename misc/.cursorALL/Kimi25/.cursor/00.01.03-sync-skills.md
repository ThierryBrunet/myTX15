# Synchronization Skills

## 01.00.00 - Overview

This document defines the synchronization workflows between the RadioMaster TX15 SD card and the Git repository.

### 01.01.00 - Paths Configuration

```yaml
Paths:
  RadioSD: "D:\"                    # TX15 SD Card mount point
  GitRepo: "C:\Users\thier\OneDrive\Workspaces\ExpressLRS\RadioMaster_TX15\myTX15\EdgeTX"
  BackupDir: "C:\Users\thier\OneDrive\Workspaces\ExpressLRS\RadioMaster_TX15\Backups"

Folders:
  SyncFolders:
    - "MODELS"
    - "RADIO"
    - "SCRIPTS\Tools"
    - "SOUNDS\en"
    - "IMAGES"

  ExcludeFiles:
    - "*.log"
    - "*.tmp"
    - "*.bak"
    - "desktop.ini"
    - "Thumbs.db"
    - "System Volume Information"
```

## 02.00.00 - Sync Modes

### 02.01.00 - SyncToRadio (Git → SD, Safe)

**Purpose**: Deploy new configurations from Git to radio without deleting existing files on radio.

**Use Cases**:
- Adding new models
- Updating existing model configurations
- Deploying script updates

**Behavior**:
- Copies new files from Git to SD
- Updates existing files if different
- Preserves extra files on SD (not in Git)
- Creates backup before operation

**Command**:
```powershell
.\Sync-TX15Config.ps1 -Mode SyncToRadio -Verbose
```

### 02.02.00 - SyncFromRadio (SD → Git, Safe)

**Purpose**: Backup radio configurations to Git without deleting repository files.

**Use Cases**:
- Backup after field tuning
- Capturing model changes made on radio
- Initial repository population

**Behavior**:
- Copies new files from SD to Git
- Updates existing files if different
- Preserves extra files in Git (not on SD)
- Creates timestamped backup

**Command**:
```powershell
.\Sync-TX15Config.ps1 -Mode SyncFromRadio -Verbose
```

### 02.03.00 - MirrorToRadio (Git → SD, Destructive)

**Purpose**: Force Git state onto radio, making SD exact copy of Git.

**Use Cases**:
- Clean slate deployment
- Removing deleted models from radio
- Recovering from corruption

**Behavior**:
- Copies all files from Git to SD
- Updates existing files
- **Deletes files on SD not in Git**
- Requires confirmation
- Creates full backup before operation

**Command**:
```powershell
.\Sync-TX15Config.ps1 -Mode MirrorToRadio -Force
```

**⚠️ WARNING**: This will delete any models or settings on the radio that are not in the Git repository!

### 02.04.00 - MirrorFromRadio (SD → Git, Destructive)

**Purpose**: Force radio state into Git, making repository exact copy of SD.

**Use Cases**:
- Full backup capture
- Migrating to new repository
- Disaster recovery

**Behavior**:
- Copies all files from SD to Git
- Updates existing files
- **Deletes files in Git not on SD**
- Requires confirmation
- Creates git commit automatically

**Command**:
```powershell
.\Sync-TX15Config.ps1 -Mode MirrorFromRadio -Force
```

**⚠️ WARNING**: This will delete any files in the repository that are not on the radio SD card!

## 03.00.00 - Pre/Post Sync Procedures

### 03.01.00 - Pre-Sync Checklist

**Before ANY sync operation:**

1. **Close EdgeTX Companion**
   ```powershell
   Get-Process *companion* | Stop-Process -Force
   ```

2. **Verify SD Card Mount**
   ```powershell
   Test-Path "D:\MODELS"
   ```

3. **Check Git Status**
   ```powershell
   cd $GitRepo
   git status
   ```

4. **Create Backup** (automatic in scripts)
   ```powershell
   # Timestamped backup created automatically
   ```

5. **Verify Radio State**
   - Radio powered off or in bootloader mode
   - No active file operations
   - SD card not write-protected

### 03.02.00 - Post-Sync Verification

**After sync completion:**

1. **Validate YAML Syntax**
   ```powershell
   Get-ChildItem "D:\MODELS" -Filter "*.yml" | ForEach-Object {
       try {
           $null = Get-Content $_.FullName | ConvertFrom-Yaml
           Write-Host "✓ $($_.Name) valid"
       } catch {
           Write-Host "✗ $($_.Name) INVALID: $_" -ForegroundColor Red
       }
   }
   ```

2. **Count Models**
   ```powershell
   $modelCount = (Get-ChildItem "D:\MODELS" -Filter "*.yml").Count
   Write-Host "Models on radio: $modelCount"
   ```

3. **Test in Companion**
   - Open EdgeTX Companion
   - Read models from radio (or local path)
   - Verify no errors
   - Check model count matches

4. **Git Commit (if SyncFrom/MirrorFrom)**
   ```powershell
   git add .
   git commit -m "Sync from TX15 - $(Get-Date -Format 'yyyy-MM-dd HH:mm')"
   ```

## 04.00.00 - Conflict Resolution

### 04.01.00 - File Comparison Strategy

**Comparison Method**: Hash-based with timestamp fallback

```powershell
function Test-FileSyncNeeded {
    param($Source, $Destination)

    if (-not (Test-Path $Destination)) {
        return $true  # New file
    }

    $srcHash = Get-FileHash $Source -Algorithm MD5
    $dstHash = Get-FileHash $Destination -Algorithm MD5

    return $srcHash.Hash -ne $dstHash.Hash
}
```

### 04.02.00 - Handling Conflicts

**Scenario 1: File modified in both locations**
- Default: Skip and log warning
- Option: Use `-ResolveConflict` parameter
  - `GitWins`: Use Git version
  - `RadioWins`: Use Radio version
  - `BackupBoth`: Keep both with timestamps

**Scenario 2: File deleted in Git but exists on Radio**
- SyncToRadio: Preserve (safe mode)
- MirrorToRadio: Delete (destructive)

**Scenario 3: File deleted on Radio but exists in Git**
- SyncFromRadio: Preserve (safe mode)
- MirrorFromRadio: Delete (destructive)

## 05.00.00 - Automation Workflows

### 05.01.00 - Pre-Flight Backup

**Trigger**: Before flying
**Action**: Quick SyncFromRadio

```powershell
# Quick backup before field session
.\Sync-TX15Config.ps1 -Mode SyncFromRadio -Quick
```

### 05.02.00 - Post-Session Sync

**Trigger**: After flying
**Action**: Full SyncFromRadio with commit

```powershell
# Full backup after field tuning
.\Sync-TX15Config.ps1 -Mode SyncFromRadio -Commit -Message "Post-flight backup"
```

### 05.03.00 - New Model Deployment

**Workflow**:
1. Create model in Companion
2. Save to Git repo
3. SyncToRadio

```powershell
# Deploy new model
.\Sync-TX15Config.ps1 -Mode SyncToRadio -Filter "MODELS\NEWMODEL.yml"
```

### 05.04.00 - Batch Operations

**Deploy all quadcopter models:**
```powershell
Get-ChildItem "$GitRepo\MODELS" -Filter "QUAD_*.yml" | ForEach-Object {
    Copy-Item $_.FullName "D:\MODELS\" -Force
}
```

**Backup only modified models:**
```powershell
.\Sync-TX15Config.ps1 -Mode SyncFromRadio -Since (Get-Date).AddHours(-2)
```

## 06.00.00 - Troubleshooting

### 06.01.00 - Common Issues

**Issue: "SD Card not found at D:\"**
```powershell
# Check available drives
Get-Volume | Where-Object { $_.DriveLetter } | Select-Object DriveLetter, FileSystemLabel

# Find EdgeTX SD card (usually labeled "EDGETX" or removable)
Get-CimInstance Win32_LogicalDisk | Where-Object { $_.DriveType -eq 2 }
```

**Issue: "File in use" errors**
```powershell
# Close all handles to D:\
Get-Process | Where-Object { $_.Modules.ModuleName -like "*D:\*" } | Stop-Process

# Or use Resource Monitor to find handle
```

**Issue: YAML parse errors after sync**
```powershell
# Validate all YAML files
$errors = @()
Get-ChildItem "D:\MODELS" -Filter "*.yml" | ForEach-Object {
    try {
        $content = Get-Content $_.FullName -Raw
        # Check for tabs (YAML requires spaces)
        if ($content -match "`t") {
            $errors += "$($_.Name): Contains tabs (use 2 spaces)"
        }
    } catch {
        $errors += "$($_.Name): $_"
    }
}
$errors
```

### 06.02.00 - Recovery Procedures

**Restore from backup:**
```powershell
# List available backups
Get-ChildItem "$BackupDir" | Sort-Object LastWriteTime -Descending | Select-Object -First 5

# Restore specific backup
$backup = Read-Host "Enter backup folder name"
Copy-Item "$BackupDir\$backup\*" "D:\" -Recurse -Force
```

**Reset to factory:**
```powershell
# Download factory SD contents from RadioMaster
# Extract to D:\ after formatting
```

## 07.00.00 - Best Practices

### 07.01.00 - Commit Messages

Format: `[Action] [Target] - [Details]`

Examples:
- `[Sync] QUAD_Angel30 - Updated rates for indoor`
- `[Add] FW_Fx707s - New fixed wing model`
- `[Fix] All Models - Corrected arming logic`
- `[Update] ELRS Lua - v3.5.4 script`

### 07.02.00 - Branching Strategy

- `main`: Production configs (tested and flown)
- `develop`: Work in progress
- `feature/[name]`: New aircraft or major changes
- `hotfix/[name]`: Urgent fixes

### 07.03.00 - Version Tagging

Tag repository after successful field testing:
```powershell
git tag -a "v2025.02.07-FieldTested" -m "All models flown and verified"
git push origin --tags
```

### 07.04.00 - Documentation

Update documentation when:
- Adding new aircraft type
- Changing arming procedure
- Updating receiver configuration
- Modifying safety logic

**Template for model changes:**
```markdown
## Change Log - [Model Name] - [Date]

### Modified
- [ ] Inputs
- [ ] Mixes
- [ ] Logical Switches
- [ ] Special Functions
- [ ] Flight Modes

### Reason
[Brief explanation]

### Testing
- [ ] Bench test passed
- [ ] Range check passed
- [ ] Flight tested

### Safety Impact
[None / Low / Medium / High]
```
